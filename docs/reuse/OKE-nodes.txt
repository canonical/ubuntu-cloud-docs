.. Introduction to Ubuntu OKE node

==============================================================

Start: Intro and prereqs

Ubuntu images are available for OKE worker nodes, with support for a select number of suites and Kubernetes versions. For a list of supported OKE configurations, see our :doc:`Ubuntu availability on OKE </oracle-reference/ubuntu-availability-on-oke>` page.

Prerequisites
-------------

You'll need:

- Oracle Cloud compartment to create the nodes.

- Oracle's ``oci`` CLI installed.

- ``kubectl`` installed.

- `Domain`_, `Dynamic Group and Policy`_ configured (Self-Managed only). 

End: Intro and prereqs

==============================================================

Start: Get Ubuntu image access

Get Ubuntu image access
---------------------------

.. attention::
    Ubuntu worker node images for OKE are currently in a Limited Availability (LA) release. To gain access to the images, reach out to your Oracle account or support teams to express interest in this LA. 

Once access has been provided to your tenancy and region then you must add an additional `Policy`_ to your root compartment to permit the listing of these images. Below are the required contents of the `Policy`_.

.. code:: console

    Define tenancy oke as ocid1.tenancy.oc1..aaaaaaaa5vrtu4bjcqpjvbworiwffgccrgrbkum64mtn33yrccjrqpzuyara 
    Endorse any-user to read instance-images in tenancy oke

.. note:: 
    
    The tenancy OCID listed above for the `Policy`_ belongs to the OCI OKE Service, it is not owned by Canonical.

End: Get Ubuntu image access

Start: Find an image

Find an Ubuntu image
-----------------------

Once your tenancy has been enabled for the LA, you will be able to list the images from API or view them through the OCI Console. 

.. tabs::

    .. group-tab:: API

        Prior to running any ``oci`` commands, be sure that your ``~/.oci/config`` is configured to use your region specified for the LA enablement.

        Otherwise, start by listing all OKE compatible images and savings them to the ``node-pool-options.json`` file. The file will contain a list of all available OKE images including your newly added Ubuntu images.
    
        .. code:: bash
            
            oci ce node-pool-options get --compartment-id <compartment-id> --node-pool-option-id all | tee node-pool-options.json
        
        Use the following to filter it down to only the newly added Ubuntu images.
        
        .. code:: bash
        
            jq -r '.data.sources[] | select(."source-name" | contains("ubuntu"))' node-pool-options.json
        
        The results should be comprised of a list of objects that contain an ``image-id``, ``source-name`` and ``source-type``.
        
        .. code:: json
            
            {
              "image-id": "ocid1.image.oc1.phx.aaaaaaaajqzb5jcbcvh5obyg2l2hzzw5qewwhrknvlyb3zaglduivigvo4sq",
              "source-name": "ubuntu-amd64-minimal-22.04-jammy-v20250604.1-OKE-1.31.1",
              "source-type": "IMAGE"
            }

        Make note of the ``image-id`` for the image(s) that you wish to use since they will be required in later steps.

    .. group-tab:: Console
        
        Whether you decide to create nodes using :guilabel:`Create Cluster` > :guilabel:`Quick Create` or :guilabel:`Add node pool`, both will let you select your desired node image. That list will contain all available OKE images and including your newly added Ubuntu images. 

        .. image:: deploy-ubuntu-oke-nodes/oke-browse.png
           :align: center
        
        After selecting your desired image based on the architecture, Ubuntu suite and Kubernetes version, your configuration should look similar to the image below.

        .. image:: deploy-ubuntu-oke-nodes/oke-create-cluster.png
           :align: center

        .. warning::
            
            Pay attention to which image you select and ensure it's architecture corresponds to your selected pod shape.

        When launching Ubuntu nodes from the Console during the LA, it's required to provide custom cloud-init ``user-data`` to the instances to ensure they join the cluster properly.

        Managed node ``user-data`` is quite simple:
        
        .. code:: yaml
           
            #cloud-config
        
            runcmd:
            - oke bootstrap
        
        While Self-Managed ``user-data`` requires variable substitution for the cluster certificate and private control plane IP:
        
        .. code:: yaml
        
           #cloud-config
        
            runcmd:
              - oke bootstrap --ca ${cluster_ca_cert} --apiserver-host ${api_server_endpoint}
            
            write_files:
              - path: /etc/oke/oke-apiserver
                permissions: '0644'
                content: ${api_server_endpoint}
              - encoding: b64
                path: /etc/kubernetes/ca.crt
                permissions: '0644'
                content: ${cluster_ca_cert}

        Copy the ``user-data`` required for your node type and paste it into the Console.

        .. image:: deploy-ubuntu-oke-nodes/oke-paste-user-data.png
           :align: center


End: Find an image

==============================================================


Start: References and links


Further references
------------------

For more information about ``oci`` CLI and managing self-managed nodes on your cluster, refer to the Oracle Documentation:

* `oci CLI documentation`_
* `Creating and managing kubernetes clusters`_
* `Creating a dynamic group and a policy for self-managed nodes <Dynamic Group and Policy_>`_
* `Creating cloud-init scripts for self-managed nodes`_

.. _`node cycling for managed nodes`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengupgradingk8sworkernode.htm
.. _`node cycling for self-managed nodes`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengupgradingselfmanagednodes.htm#contengupgradingselfmanagednodes
.. _`working with self-managed nodes`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengworkingwithselfmanagednodes.htm
.. _`creating a cluster`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/create-cluster.htm
.. _`import from-object-uri`: https://docs.oracle.com/en-us/iaas/tools/oci-cli/3.63.3/oci_cli_docs/cmdref/compute/image/import/from-object-uri.html
.. _`object upload`: https://docs.oracle.com/en-us/iaas/tools/oci-cli/3.45.2/oci_cli_docs/cmdref/os/object/put.html
.. _`image import from object`: https://docs.oracle.com/en-us/iaas/tools/oci-cli/3.45.2/oci_cli_docs/cmdref/compute/image/import/from-object.html
.. _`managing custom images`: https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/managingcustomimages.htm
.. _`OCI CLI documentation`: https://docs.oracle.com/en-us/iaas/tools/oci-cli/3.63.3/oci_cli_docs/
.. _`Creating and managing kubernetes clusters`: https://docs.public.oneportal.content.oci.oraclecloud.com/en-us/iaas/compute-cloud-at-customer/topics/oke/creating-and-managing-kubernetes-clusters.htm
.. _`Dynamic Group and Policy`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdynamicgrouppolicyforselfmanagednodes.htm
.. _`Creating cloud-init scripts for self-managed nodes`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengcloudinitforselfmanagednodes.htm
.. _`Domain`: https://docs.oracle.com/en-us/iaas/Content/Identity/domains/to-create-new-identity-domain.htm
.. _`cluster-networking`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengnetworkconfig.htm
.. _`gh-example-repo`: https://github.com/canonical/oracle-doc-examples/tree/main/deploy-oke-using-ubuntu/terraform
.. _`cli-example-repo`: https://github.com/canonical/oracle-doc-examples/tree/main/deploy-oke-using-ubuntu/cli
.. _`terraform-example-repo`: https://github.com/canonical/oracle-doc-examples/tree/main/deploy-oke-using-ubuntu/terraform
.. _`security lists`: https://docs.oracle.com/en-us/iaas/Content/Network/Concepts/securitylists.htm
.. _`ubuntu-oke-availability`: https://documentation.ubuntu.com/oracle/oracle-reference/ubuntu-availability-on-oke/
.. _`gh-oci-terraform-provider`: https://github.com/oracle/terraform-provider-oci
.. _`gh-oke-terraform-module`: https://github.com/oracle-terraform-modules/terraform-oci-oke
.. _`managed-nodes-docs`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengworkingwithmanagednodes.htm
.. _`self-managed-nodes-docs`: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengworkingwithselfmanagednodes.htm
.. _`Policy`: https://cloud.oracle.com/identity/domains/policies

End: References and links

==============================================================
